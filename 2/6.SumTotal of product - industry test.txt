SumTotal of product - industry test

問題文
横一列に並んだ N 個の空きマスと，N 個の数 A1,A2,…,AN がある．

N 個の空きマスに，A1,A2,…,AN をちょうど1 回ずつ割り当て，全ての隣接するマスのペアについてそれらに割り当てられている数の積の和を計算したもの S を最大化したい．ただし，いくつかの数については，既に割り当てるマスが確定している．あなたの仕事は，S の最大値を出力することである．

左から i(1≦i≦N) 番目のマスに割り当てられた数の添字を Ii と表すとき，S は S=AI1×AI2+AI2×AI3+…++AIN−1×AIN と表せる．

入力
入力は以下の形式で標準入力から与えられる．

N
A1 D1
A2 D2
:
AN D3
1 行目には，整数 N(1≦N≦16) が与えられる．
2 行目から N 行には，各数に関する情報が与えられる．そのうち　i　行目には，i 番目の整数の値 Ai(−100≦Ai≦100) と，その整数が既に割り当てられているかどうかと，割り当てられている場合どのマスに割り当てられているかを表す整数 Di(1≦Di≦N または Di=−1) が与えられる．Di≧0 のとき，Ai が左から Di 番目のマスに割り当てられていることを意味する．Di=−1のとき，その整数はまだ割り当てられていないことを意味する．
同じマスに複数の数が割り当てられることはない．
出力
1 行目には，達成できる S の最大値が書かれている．

末尾の改行を忘れないこと．

入力例1
5
10 -1
20 -1
50 -1
40 -1
30 -1
出力例1
4600
例えば，各マスに左から 10,30,50,40,20 と割り当てることによって， 10×30+30×50+50×40+40×20=4600 になり，これが達成できる最大値である．

入力例2
6
10 3
20 -1
50 -1
40 -1
30 -1
60 6
出力例2
6300
このケースにおいて，左から 3 番目のマスに 10，6 番目のマスに 60 を割り当てることは既に決まっている．
このケースにおいては，各マスに左から 20,30,10,40,50,60 と割り当てれば最大値 6300 を達成できる．

入力例3
2
100 -1
0 -1
出力例3
0

入力例4
16
1 -1
-2 -1
3 -1
-4 -1
5 -1
-6 -1
7 -1
-8 -1
9 -1
10 -1
11 -1
12 -1
13 -1
14 -1
15 -1
-16 -1
出力例4
1342

入力例5
16
-8 -1
0 -1
0 11
8 -1
-10 -1
7 -1
-2 -1
-7 -1
0 -1
-4 -1
-4 8
-10 -1
-4 1
0 -1
-8 -1
6 -1
出力例5
504